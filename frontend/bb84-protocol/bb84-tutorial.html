<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB84 Quantum Key Distribution Protocol - Interactive Tutorial</title>
    <meta name="description" content="Learn the BB84 quantum key distribution protocol with interactive simulations, step-by-step explanations, and comprehensive security analysis.">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/quantum-visualizations.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="main-header">
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="logo"><a href="../index.html">QuantumCrypto Tutorial</a></h1>
                <ul class="nav-menu">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../quantum-basics/quantum-intro.html">Quantum Basics</a></li>
                    <li><a href="#bb84-protocol" class="active">BB84 Protocol</a></li>
                    <li><a href="../../about.html">About</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Backend Status Indicator -->
    <div class="backend-status" id="backend-status">
        <span id="backend-indicator">üîÑ Connecting to Python backend...</span>
    </div>

    <main class="lesson-content">
        <div class="container">
            <div class="lesson-header">
                <h1>üîê BB84 Quantum Key Distribution Protocol</h1>
                <p class="lesson-subtitle">
                    Master the fundamentals of quantum cryptography through interactive learning, 
                    step-by-step explanations, and real Python quantum simulations
                </p>
            </div>

            <div class="lesson-navigation">
                <div class="nav-item current">
                    <span class="nav-number">01</span>
                    <span class="nav-title">BB84 Overview</span>
                </div>
                <div class="nav-item">
                    <span class="nav-number">02</span>
                    <span class="nav-title">Security Analysis</span>
                </div>
                <div class="nav-item">
                    <span class="nav-number">03</span>
                    <span class="nav-title">Simulation</span>
                </div>
                <div class="nav-item">
                    <span class="nav-number">04</span>
                    <span class="nav-title">Results</span>
                </div>
            </div>

            <article class="lesson-article">
                <!-- Introduction Section -->
                <section class="content-section">
                    <h2>üéì What is BB84 Quantum Key Distribution?</h2>

                    <div class="highlight-box">
                        <h3>ü§î The Problem BB84 Solves</h3>
                        <p>
                            Traditional cryptography relies on mathematical complexity‚Äîit assumes certain problems are hard to solve. 
                            But what if quantum computers break these assumptions? BB84 offers a revolutionary solution: 
                            <strong>security based on the laws of physics, not mathematics</strong>.
                        </p>
                    </div>

                    <div class="highlight-box success">
                        <h3>üîë Core Idea</h3>
                        <p>
                            BB84 uses quantum properties to detect eavesdropping. Any attempt to intercept the quantum key 
                            will leave detectable traces, guaranteeing perfect security through the 
                            <strong>uncertainty principle</strong>.
                        </p>
                    </div>

                    <div class="demo-container">
                        <div class="demo-explanation">
                            <h4>üéØ The BB84 Challenge</h4>
                            <div style="margin: 20px 0; text-align: center;">
                                Alice <span class="particle-animation"></span><span class="particle-animation"></span><span class="particle-animation"></span> 
                                ‚Üí Eve? ‚Üí <span class="particle-animation"></span><span class="particle-animation"></span><span class="particle-animation"></span> Bob
                            </div>
                            <p><em>Alice sends quantum states to Bob. Can Eve intercept them without being detected?</em></p>
                        </div>
                    </div>
                </section>

                <!-- Protocol Steps Section -->
                <section class="content-section">
                    <h2>üß† Understanding the BB84 Protocol</h2>
                    <p>Let's break down how BB84 works step by step, with clear explanations and visual examples.</p>

                    <div class="highlight-box">
                        <h3>üìã Complete Protocol Overview</h3>
                        <div class="protocol-flow">
                            <div class="flow-step">
                                <div class="step-icon">1</div>
                                <div>
                                    <strong>Alice's Preparation:</strong> Alice generates random bits (0s and 1s) and randomly chooses 
                                    measurement bases (+ or √ó) for each bit.
                                </div>
                            </div>
                            <div class="flow-arrow">‚¨áÔ∏è</div>
                            <div class="flow-step">
                                <div class="step-icon">2</div>
                                <div>
                                    <strong>Quantum Encoding:</strong> Alice encodes each bit as a photon with specific polarization 
                                    based on her chosen basis and bit value.
                                </div>
                            </div>
                            <div class="flow-arrow">‚¨áÔ∏è</div>
                            <div class="flow-step">
                                <div class="step-icon">3</div>
                                <div>
                                    <strong>Quantum Transmission:</strong> Photons travel through a quantum channel 
                                    (subject to noise and potential eavesdropping).
                                </div>
                            </div>
                            <div class="flow-arrow">‚¨áÔ∏è</div>
                            <div class="flow-step">
                                <div class="step-icon">4</div>
                                <div>
                                    <strong>Bob's Measurement:</strong> Bob randomly chooses measurement bases and measures 
                                    each received photon, obtaining his measurement results.
                                </div>
                            </div>
                            <div class="flow-arrow">‚¨áÔ∏è</div>
                            <div class="flow-step">
                                <div class="step-icon">5</div>
                                <div>
                                    <strong>Basis Reconciliation:</strong> Alice and Bob publicly compare their measurement bases 
                                    (not the results!) and keep only bits where they used the same basis.
                                </div>
                            </div>
                            <div class="flow-arrow">‚¨áÔ∏è</div>
                            <div class="flow-step">
                                <div class="step-icon">6</div>
                                <div>
                                    <strong>Error Detection:</strong> They test a random sample of their shared bits to calculate 
                                    the QBER. High QBER indicates eavesdropping!
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Interactive Encoding Example -->
                    <div class="demo-container">
                        <div class="demo-explanation">
                            <h4>üî¨ Interactive Encoding Example</h4>
                            <p>Let's see how Alice encodes a bit. Click the buttons to explore different combinations:</p>
                        </div>
                        <div class="demo-controls">
                            <button class="btn btn-secondary" onclick="showEncoding(0, '+')">Bit 0 in + Basis</button>
                            <button class="btn btn-secondary" onclick="showEncoding(1, '+')">Bit 1 in + Basis</button>
                            <button class="btn btn-secondary" onclick="showEncoding(0, 'x')">Bit 0 in √ó Basis</button>
                            <button class="btn btn-secondary" onclick="showEncoding(1, 'x')">Bit 1 in √ó Basis</button>
                        </div>
                        <div id="encoding-result" class="demo-results">
                            <p>Click a button above to see how Alice encodes different bit-basis combinations!</p>
                        </div>
                    </div>

                    <div class="highlight-box warning">
                        <h3>‚ö†Ô∏è Why This Works</h3>
                        <p>
                            The key insight is that if Bob measures a photon in the <strong>wrong basis</strong>, 
                            he gets a random result (50% chance of error). But if Eve tries to eavesdrop, 
                            she doesn't know the correct basis either, so she introduces detectable errors!
                        </p>
                    </div>
                </section>

                <!-- Security Analysis Section -->
                <section class="content-section">
                    <h2>üõ°Ô∏è Why is BB84 Secure?</h2>
                    <p>Understanding the quantum physics behind unbreakable security</p>

                    <div class="application-grid">
                        <div class="app-card">
                            <h4>üîç No-Cloning Theorem</h4>
                            <p>Quantum mechanics forbids creating perfect copies of unknown quantum states. 
                            Eve cannot simply copy the photons without disturbing them.</p>
                        </div>
                        <div class="app-card">
                            <h4>üìä Measurement Disturbance</h4>
                            <p>When Eve measures a photon to learn its state, 
                            she inevitably disturbs it. This introduces errors that Alice and Bob can detect.</p>
                        </div>
                        <div class="app-card">
                            <h4>üé≤ Basis Uncertainty</h4>
                            <p>Eve doesn't know which basis Alice used, so she must guess. 
                            Wrong guesses lead to errors in Bob's measurements.</p>
                        </div>
                        <div class="app-card">
                            <h4>üìà Statistical Detection</h4>
                            <p>Even sophisticated attacks leave statistical signatures 
                            that can be detected through QBER analysis.</p>
                        </div>
                    </div>

                    <div class="highlight-box success">
                        <h3>üéØ Security Guarantee</h3>
                        <p>
                            BB84 provides <strong>information-theoretic security</strong>: even with unlimited computational power, 
                            an eavesdropper cannot break the protocol without being detected. The security is guaranteed by 
                            the fundamental laws of quantum mechanics, not mathematical assumptions.
                        </p>
                    </div>
                </section>

                <!-- Simulation Configuration Section -->
                <section class="content-section">
                    <h2>üî¨ Interactive Quantum Simulation</h2>
                    <p>Experience authentic BB84 with our Python-powered quantum backend</p>

                    <div class="highlight-box">
                        <h3>üêç Professional Python Backend</h3>
                        <p>
                            Our simulation uses real quantum computing libraries:
                            <strong>Qiskit</strong> (IBM's quantum framework) for small simulations and 
                            <strong>QuTiP</strong> (Quantum Toolbox in Python) for larger systems. 
                            This gives you authentic quantum behavior, not simplified approximations!
                        </p>
                    </div>

                    <div class="demo-container">
                        <div class="demo-explanation">
                            <h4>üéÆ Configure Your Quantum Experiment</h4>
                        </div>
                        
                        <div class="control-panel">
                            <div class="control-group">
                                <label>üìä Number of Qubits to Transmit:</label>
                                <input type="number" id="numBits" value="50" min="4" max="1000" class="form-input">
                                <small class="help-text">
                                    üéì <strong>Educational tip:</strong> Start with 10-20 bits to see individual results clearly, 
                                    then try 100+ for realistic protocol behavior.
                                </small>
                            </div>

                            <div class="control-group">
                                <label>üëÅÔ∏è Include Eavesdropper (Eve):</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="includeEve">
                                    <span>Simulate quantum eavesdropping attack</span>
                                </div>
                                <div class="highlight-box info">
                                    <small>
                                        <strong>üéì What this does:</strong> Eve intercepts each photon, measures it 
                                        (guessing the basis), then sends a new photon to Bob based on her measurement. 
                                        This introduces detectable errors!
                                    </small>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>üåä Quantum Channel Noise:</label>
                                <input type="range" id="noiseLevel" min="0" max="0.3" step="0.01" value="0.05" class="form-range">
                                <span id="noiseValue" class="range-value">5.0%</span>
                                <div class="noise-levels">
                                    <small>0-2%: Excellent lab conditions</small>
                                    <small>3-8%: Typical fiber optic QKD</small>
                                    <small>9%+: Challenging conditions</small>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>üîß Security Analysis Level:</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="advancedAnalysis" checked>
                                    <span>Advanced finite-key security analysis</span>
                                </div>
                                <div class="highlight-box success">
                                    <small>
                                        <strong>üî¨ Includes:</strong> Renner bounds, statistical confidence intervals, 
                                        attack detection algorithms, and modern LDPC/Polar error correction analysis.
                                    </small>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>‚öõÔ∏è Quantum Computing Backend:</label>
                                <select id="backendChoice" class="form-select">
                                    <option value="auto">ü§ñ Auto-select (Recommended)</option>
                                    <option value="qiskit">üî¨ Force Qiskit (Educational)</option>
                                    <option value="qutip">‚ö° Force QuTiP (Performance)</option>
                                </select>
                            </div>
                        </div>

                        <div class="highlight-box warning">
                            <h4>üéì Learning Tips</h4>
                            <ul>
                                <li><strong>First time?</strong> Try 10 bits, no Eve, 5% noise</li>
                                <li><strong>See eavesdropping?</strong> Enable Eve and watch QBER increase</li>
                                <li><strong>Challenge yourself:</strong> Try 100+ bits with Eve and high noise</li>
                                <li><strong>Compare backends:</strong> Run same parameters with different backends</li>
                            </ul>
                        </div>

                        <div class="demo-controls">
                            <button class="btn btn-primary" onclick="runPythonBB84Simulation()" id="simulateBtn">
                                üöÄ Start Quantum Key Distribution
                            </button>
                        </div>
                        <div class="progress-bar" id="progressBar" style="display: none;">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </section>

                <!-- Results Section -->
                <section class="content-section">
                    <h2>üìà Simulation Results & Analysis</h2>
                    <p>Comprehensive analysis of your quantum key distribution experiment</p>

                    <div class="demo-container">
                        <div id="simulation-results" class="demo-results">
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 3em; margin-bottom: 20px;">üéØ</div>
                                <h3>Ready for Quantum Cryptography!</h3>
                                <p>Configure your parameters above and click "Start Quantum Key Distribution" to begin your BB84 simulation.</p>
                                <div class="highlight-box">
                                    <h4>üìñ What You'll See</h4>
                                    <ul style="text-align: left; margin: 15px 0;">
                                        <li><strong>Protocol Steps:</strong> Detailed breakdown of each BB84 phase</li>
                                        <li><strong>QBER Analysis:</strong> Error rate calculation and security assessment</li>
                                        <li><strong>Key Generation:</strong> Final secure key with entropy analysis</li>
                                        <li><strong>Security Verdict:</strong> Whether the protocol succeeded or detected attacks</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Export Controls -->
                        <div class="export-controls" id="export-controls" style="display: none;">
                            <h4>üì§ Export Your Results</h4>
                            <p>Save your simulation data for further analysis or education</p>
                            <div class="demo-controls">
                                <button class="btn btn-outline" onclick="exportResults('json')">üìÑ Export as JSON</button>
                                <button class="btn btn-outline" onclick="exportResults('csv')">üìä Export as CSV</button>
                                <button class="btn btn-outline" onclick="exportResults('pdf')">üìã Generate Report</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Advanced Analysis Section -->
                <section class="content-section">
                    <h2>üõ°Ô∏è Advanced Security Analysis</h2>
                    <p>Professional-grade security assessment with modern cryptographic tools</p>

                    <div class="highlight-box">
                        <h3>üéì Understanding Advanced Analysis</h3>
                        <p>
                            Our advanced analysis goes beyond basic QBER calculation. We implement state-of-the-art 
                            security analysis including <strong>finite-key bounds</strong> (accounting for the fact that 
                            real protocols use finite-length keys), <strong>statistical confidence intervals</strong>, 
                            and <strong>attack characterization</strong> using machine learning techniques.
                        </p>
                    </div>

                    <div class="demo-container">
                        <div id="advanced-analysis" style="display: none;">
                            <div class="tab-container">
                                <div class="tab-buttons">
                                    <button class="tab-button active" onclick="showTab('finite-key-tab')">üîç Finite-Key Security</button>
                                    <button class="tab-button" onclick="showTab('qber-stats-tab')">üìä QBER Statistics</button>
                                    <button class="tab-button" onclick="showTab('attack-char-tab')">üéØ Attack Analysis</button>
                                    <button class="tab-button" onclick="showTab('optimization-tab')">üîß Optimization</button>
                                </div>
                                <div class="tab-content active" id="finite-key-tab">
                                    <h4>üîç Finite-Key Security Bounds</h4>
                                    <div class="highlight-box">
                                        <p>
                                            Real-world QKD uses keys of finite length, unlike theoretical analysis that assumes 
                                            infinite-length keys. Finite-key analysis accounts for statistical fluctuations and 
                                            provides realistic security bounds.
                                        </p>
                                    </div>
                                    <div id="finite-key-analysis">Analysis will appear after simulation...</div>
                                </div>
                                <div class="tab-content" id="qber-stats-tab">
                                    <h4>üìä Statistical QBER Analysis</h4>
                                    <div class="highlight-box">
                                        <p>
                                            QBER (Quantum Bit Error Rate) is the key security metric. We calculate statistical 
                                            confidence intervals and perform hypothesis testing to determine if observed errors 
                                            indicate eavesdropping or just natural noise.
                                        </p>
                                    </div>
                                    <div id="qber-analysis">Analysis will appear after simulation...</div>
                                </div>
                                <div class="tab-content" id="attack-char-tab">
                                    <h4>üéØ Attack Characterization</h4>
                                    <div class="highlight-box">
                                        <p>
                                            Different eavesdropping attacks leave different signatures in the error patterns. 
                                            Our analysis attempts to identify the most likely attack type and assess the 
                                            sophistication level of any detected eavesdropper.
                                        </p>
                                    </div>
                                    <div id="attack-analysis">Analysis will appear after simulation...</div>
                                </div>
                                <div class="tab-content" id="optimization-tab">
                                    <h4>üîß Performance Optimization</h4>
                                    <div class="highlight-box">
                                        <p>
                                            Based on your simulation results, we provide specific recommendations for 
                                            improving protocol performance, including optimal error correction codes, 
                                            backend selection, and parameter tuning.
                                        </p>
                                    </div>
                                    <div id="optimization-recommendations">Recommendations will appear after simulation...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Final Key Display Section -->
                <section class="content-section">
                    <h2>üîë Generated Quantum Key</h2>

                    <div class="highlight-box">
                        <h3>üéì Understanding Your Quantum Key</h3>
                        <p>
                            The key shown below was generated using authentic quantum processes. Each bit represents 
                            a successfully transmitted and verified quantum state. The <strong>entropy</strong> measures 
                            randomness quality (1.000 is perfect), and the <strong>security status</strong> tells you 
                            if the key is safe to use for encryption.
                        </p>
                    </div>

                    <div class="demo-container" id="final-key" style="display: none;">
                        <h3>üîê Information-Theoretically Secure Key</h3>
                        <div id="key-content"></div>
                        <div class="key-info">
                            <div id="key-length"></div>
                            <div id="key-entropy"></div>
                            <div id="backend-used"></div>
                            <div id="key-metadata"></div>
                        </div>
                        <div id="security-status" class="security-indicator"></div>

                        <div class="highlight-box warning">
                            <h4>üîê Security Notice</h4>
                            <p>
                                This key was generated for educational purposes. In a real QKD system, 
                                this key would be immediately used for encryption and then securely deleted. 
                                Never reuse quantum keys!
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Summary Section -->
                <section class="content-section">
                    <h2>üéì What Did You Learn?</h2>

                    <div class="highlight-box success">
                        <h3>üß† Key Takeaways</h3>
                        <div class="application-grid">
                            <div class="app-card">
                                <h4>üî¨ Quantum Physics Enables Security</h4>
                                <p>BB84's security comes from fundamental quantum properties like the no-cloning theorem and measurement disturbance, not mathematical complexity.</p>
                            </div>
                            <div class="app-card">
                                <h4>üìä QBER is the Key Metric</h4>
                                <p>The Quantum Bit Error Rate tells you if someone is eavesdropping. Low QBER (‚â§11%) means secure, high QBER means abort the protocol.</p>
                            </div>
                            <div class="app-card">
                                <h4>üé≤ Random Basis Selection is Crucial</h4>
                                <p>Both Alice and Bob must choose bases randomly. This ensures that eavesdroppers can't predict the correct measurement basis.</p>
                            </div>
                            <div class="app-card">
                                <h4>üîê Information-Theoretic Security</h4>
                                <p>Unlike classical cryptography, BB84's security doesn't depend on computational assumptions‚Äîit's guaranteed by physics.</p>
                            </div>
                        </div>
                    </div>

                    <div class="highlight-box">
                        <h3>üöÄ Next Steps in Quantum Cryptography</h3>
                        <p>
                            Now that you understand BB84, you're ready to explore advanced quantum cryptographic protocols:
                        </p>
                        <ul>
                            <li><strong>E91 Protocol:</strong> Uses quantum entanglement for key distribution</li>
                            <li><strong>SARG04:</strong> Improved version of BB84 with better noise tolerance</li>
                            <li><strong>Continuous Variable QKD:</strong> Uses quantum properties of light waves</li>
                            <li><strong>Device-Independent QKD:</strong> Security without trusting measurement devices</li>
                            <li><strong>Quantum Digital Signatures:</strong> Quantum authentication and non-repudiation</li>
                        </ul>
                    </div>
                </section>
            </article>

            <div class="lesson-footer">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
                <div class="lesson-actions">
                    <a href="../quantum-basics/quantum-intro.html" class="btn btn-outline">‚Üê Back to Quantum Basics</a>
                    <a href="../index.html" class="btn btn-primary">Explore More Protocols ‚Üí</a>
                </div>
            </div>
        </div>
    </main>

    <style>
        /* Backend Status Indicator */
        .backend-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .backend-connected {
            color: #2ecc71;
            border-color: #2ecc71;
        }

        .backend-disconnected {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .backend-connecting {
            color: #f39c12;
            border-color: #f39c12;
        }

        /* Protocol Flow Styling */
        .protocol-flow {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .step-icon {
            background: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
            flex-shrink: 0;
            color: white;
            font-weight: bold;
        }

        .flow-arrow {
            font-size: 2em;
            color: var(--primary-color);
            text-align: center;
            margin: 10px 0;
        }

        /* Control Panel Styling */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-color);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 14px;
        }

        .form-range {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }

        .range-value {
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
        }

        .help-text {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            opacity: 0.8;
        }

        .noise-levels {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Particle Animation */
        .particle-animation {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            margin: 0 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Tab System */
        .tab-container {
            margin: 20px 0;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 25px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Export Controls */
        .export-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Security Indicator */
        .security-indicator {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .security-indicator.secure { 
            background: #2ecc71; 
            color: white;
        }

        .security-indicator.insecure { 
            background: #e74c3c; 
            color: white;
        }

        /* Key Display */
        .key-info {
            margin: 15px 0;
            font-family: 'JetBrains Mono', monospace;
        }

        .bit-visualization {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .bit {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .bit:hover {
            transform: scale(1.1);
        }

        .bit-0 { background: #3498db; color: white; }
        .bit-1 { background: #e74c3c; color: white; }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .control-panel {
                grid-template-columns: 1fr;
            }

            .backend-status {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px 0;
            }

            .tab-buttons {
                flex-direction: column;
            }

            .protocol-flow {
                align-items: center;
            }

            .flow-step {
                max-width: 90%;
            }
        }
    </style>

    <script>
        // Enhanced global state management
        let simulationRunning = false;
        let backendConnected = false;
        let currentSimulationId = null;
        let lastSimulationResults = null;
        let backendCapabilities = {};

        const BACKEND_URL = 'http://localhost:5000';

        // Interactive encoding demonstration
        function showEncoding(bit, basis) {
            const resultDiv = document.getElementById('encoding-result');
            let polarization, explanation;

            if (basis === '+') {
                polarization = bit === 0 ? '‚Üí (Horizontal)' : '‚Üë (Vertical)';
                explanation = `Alice chooses bit ${bit} and + basis, so she sends a ${bit === 0 ? 'horizontal' : 'vertical'} polarized photon.`;
            } else {
                polarization = bit === 0 ? '‚Üó (Diagonal +45¬∞)' : '‚Üñ (Diagonal -45¬∞)';
                explanation = `Alice chooses bit ${bit} and √ó basis, so she sends a ${bit === 0 ? '+45¬∞' : '-45¬∞'} polarized photon.`;
            }

            resultDiv.innerHTML = `
                <div style="font-size: 1.5em; margin-bottom: 10px; text-align: center;">
                    Bit: <span style="color: var(--primary-color);">${bit}</span> | 
                    Basis: <span style="color: #2ecc71;">${basis}</span> | 
                    Photon: <span style="color: #f39c12;">${polarization}</span>
                </div>
                <p><strong>Explanation:</strong> ${explanation}</p>
                <div style="margin-top: 15px; font-size: 12px; opacity: 0.8; text-align: center;">
                    ${basis === '+' ? 'Rectilinear basis uses horizontal/vertical polarization' : 'Diagonal basis uses ¬±45¬∞ polarization'}
                </div>
            `;
        }

        // Enhanced backend connection
        async function initializeBackend() {
            try {
                updateBackendStatus('connecting', 'üîÑ Connecting to Python backend...');

                const response = await fetch(`${BACKEND_URL}/api/health`);
                if (response.ok) {
                    const healthData = await response.json();
                    backendConnected = true;
                    backendCapabilities = healthData.features || {};

                    updateBackendStatus('connected', `‚úÖ Python Backend v${healthData.version || '2.2.0'} Connected`);
                    console.log('Backend capabilities:', backendCapabilities);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                backendConnected = false;
                updateBackendStatus('disconnected', '‚ùå Backend Unavailable');
                console.error('Backend connection failed:', error);
            }
        }

        function updateBackendStatus(status, message) {
            const indicator = document.getElementById('backend-indicator');
            const statusDiv = document.getElementById('backend-status');

            indicator.textContent = message;
            statusDiv.className = `backend-status backend-${status}`;
        }

        // Enhanced simulation with educational feedback
        async function runPythonBB84Simulation() {
            if (simulationRunning) return;

            if (!backendConnected) {
                alert('üîå Python backend not connected!\n\nPlease ensure the Flask server is running on ' + BACKEND_URL + '\n\nThe simulation requires our quantum computing backend for authentic results.');
                return;
            }

            simulationRunning = true;

            // Get parameters with validation
            const numBits = parseInt(document.getElementById('numBits').value);
            const includeEve = document.getElementById('includeEve').checked;
            const noiseLevel = parseFloat(document.getElementById('noiseLevel').value);
            const advancedAnalysis = document.getElementById('advancedAnalysis').checked;
            const backendChoice = document.getElementById('backendChoice').value;

            // Validate parameters
            if (numBits < 4 || numBits > 1000) {
                alert('Please choose between 4 and 1000 qubits for realistic simulation.');
                simulationRunning = false;
                return;
            }

            const simulateBtn = document.getElementById('simulateBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            // Enhanced UI feedback
            simulateBtn.innerHTML = '<span class="loading-spinner"></span> Running Quantum Simulation...';
            simulateBtn.disabled = true;
            progressBar.style.display = 'block';

            // Educational loading messages
            const loadingMessages = [
                'Initializing quantum states...',
                'Preparing photon polarizations...',
                'Transmitting through quantum channel...',
                'Detecting eavesdropping attempts...',
                'Performing error correction...',
                'Calculating security bounds...',
                'Generating final secure key...'
            ];

            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                if (messageIndex < loadingMessages.length) {
                    document.getElementById('simulation-results').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
                            <h3 style="margin-top: 20px;">üî¨ ${loadingMessages[messageIndex]}</h3>
                            <p>Backend: ${backendChoice === 'auto' ? (numBits < 20 ? 'Qiskit' : 'QuTiP') : backendChoice}</p>
                            <p><small>Qubits: ${numBits} | Noise: ${(noiseLevel * 100).toFixed(1)}% | Eve: ${includeEve ? 'Yes' : 'No'}</small></p>
                        </div>
                    `;
                    messageIndex++;
                }
            }, 800);

            try {
                // Progress animation
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 3;
                    progressFill.style.width = Math.min(progress, 90) + '%';
                }, 150);

                const protocolParams = {
                    num_bits: numBits,
                    eavesdropper_present: includeEve,
                    noise_level: noiseLevel,
                    error_correction: true,
                    backend: backendChoice,
                    advanced_analysis: advancedAnalysis
                };

                console.log('üöÄ Starting BB84 simulation:', protocolParams);

                const response = await fetch(`${BACKEND_URL}/api/bb84/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(protocolParams)
                });

                clearInterval(progressInterval);
                clearInterval(messageInterval);
                progressFill.style.width = '95%';

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Backend error: ${response.status}\n${errorText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Simulation completed:', result);

                if (!result.success) {
                    throw new Error(result.error || 'Simulation failed');
                }

                lastSimulationResults = result;

                // Advanced analysis
                if (advancedAnalysis && backendCapabilities.security_analysis) {
                    progressFill.style.width = '98%';
                    await performAdvancedSecurityAnalysis(result);
                }

                progressFill.style.width = '100%';

                // Display results
                displayPythonResults(result);
                document.getElementById('export-controls').style.display = 'block';

            } catch (error) {
                console.error('‚ùå Simulation error:', error);
                clearInterval(messageInterval);
                document.getElementById('simulation-results').innerHTML = 
                    `<div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <div style="font-size: 3em; margin-bottom: 20px;">‚ùå</div>
                        <h3>Simulation Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <div class="highlight-box warning" style="margin-top: 20px;">
                            <h4>üîß Troubleshooting</h4>
                            <ul style="text-align: left;">
                                <li>Ensure Python backend is running on ${BACKEND_URL}</li>
                                <li>Check that all required Python packages are installed</li>
                                <li>Verify firewall isn't blocking the connection</li>
                                <li>Try refreshing the page and reconnecting</li>
                            </ul>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="runPythonBB84Simulation()" style="margin: 5px;">
                                üîÑ Retry Simulation
                            </button>
                            <button class="btn btn-outline" onclick="initializeBackend()" style="margin: 5px;">
                                üîå Reconnect Backend
                            </button>
                        </div>
                    </div>`;
            } finally {
                simulateBtn.innerHTML = 'üöÄ Start Quantum Key Distribution';
                simulateBtn.disabled = false;
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
                simulationRunning = false;
            }
        }

        // Enhanced results display with educational explanations
        function displayPythonResults(result) {
            const resultsDiv = document.getElementById('simulation-results');
            const backendUsed = result.simulation_backend || result.backend_used || 'Unknown';
            const backendReason = result.backend_reason || 'Backend selection criteria met';
            const isSecure = result.security_analysis?.security_level === 'SECURE';
            const qber = (result.error_rate || 0) * 100;

            resultsDiv.innerHTML = `
                <h3>üéâ BB84 Quantum Key Distribution Complete!</h3>

                <div class="highlight-box">
                    <h4>üéì What Just Happened?</h4>
                    <p>
                        Your quantum simulation used <strong>${backendUsed}</strong> to model authentic quantum physics. 
                        Alice sent ${result.total_bits || result.protocol_steps?.alice_preparation || 'N/A'} photons to Bob, 
                        they sifted ${result.sifted_bits || result.protocol_steps?.key_sifting || 'N/A'} matching bits, 
                        and generated a ${result.final_key_length || result.protocol_steps?.final_key_length || 'N/A'}-bit 
                        ${isSecure ? 'secure' : 'compromised'} key.
                    </p>
                </div>

                <div class="results-grid">
                    <div class="result-item">
                        <strong>üé≤ Qubits Transmitted:</strong><br>
                        ${result.protocol_steps?.alice_preparation || result.total_bits || 'N/A'}
                        <small style="display: block; margin-top: 5px; opacity: 0.8;">
                            Photons sent from Alice to Bob
                        </small>
                    </div>
                    <div class="result-item">
                        <strong>üîç Sifted Key Bits:</strong><br>
                        ${result.protocol_steps?.key_sifting || result.sifted_bits || 'N/A'}
                        <small style="display: block; margin-top: 5px; opacity: 0.8;">
                            Bits with matching bases
                        </small>
                    </div>
                    <div class="result-item">
                        <strong>üîë Final Secure Key:</strong><br>
                        ${result.protocol_steps?.final_key_length || result.final_key_length || 'N/A'} bits
                        <small style="display: block; margin-top: 5px; opacity: 0.8;">
                            After error correction & privacy amplification
                        </small>
                    </div>
                    <div class="result-item">
                        <strong>üìä QBER:</strong><br>
                        ${qber.toFixed(3)}%
                        <small style="display: block; margin-top: 5px; opacity: 0.8;">
                            ${qber <= 11 ? '‚úÖ Below security threshold' : '‚ö†Ô∏è Above security threshold'}
                        </small>
                    </div>
                    <div class="result-item">
                        <strong>‚ö° Protocol Efficiency:</strong><br>
                        ${((result.protocol_efficiency || 0) * 100).toFixed(1)}%
                        <small style="display: block; margin-top: 5px; opacity: 0.8;">
                            Final key length / initial bits
                        </small>
                    </div>
                    <div class="result-item">
                        <strong>üõ°Ô∏è Security Status:</strong><br>
                        <div class="security-indicator ${isSecure ? 'secure' : 'insecure'}">
                            ${result.security_analysis?.security_level || 'UNKNOWN'}
                        </div>
                    </div>
                </div>

                <div class="highlight-box ${isSecure ? 'success' : 'warning'}">
                    <h4>${isSecure ? 'üéâ Success!' : '‚ö†Ô∏è Security Alert'}</h4>
                    <p><strong>Quantum Analysis:</strong> ${backendUsed} simulated authentic quantum state evolution</p>
                    <p><strong>Security Assessment:</strong> ${isSecure ? 
                        'Information-theoretically secure key successfully generated! This key is protected by the laws of quantum mechanics.' : 
                        'Security compromise detected - key rejected. High QBER indicates possible eavesdropping or excessive noise.'}</p>
                    <p><strong>Educational Insight:</strong> ${result.eavesdropper_present ? 
                        'Notice how Eve\'s eavesdropping increased the error rate, demonstrating quantum security in action!' : 
                        'The low error rate confirms no eavesdropping was detected during transmission.'}</p>
                </div>
            `;

            // Display the final key
            if (result.final_key && result.final_key.length > 0) {
                displayFinalKey(result);
            } else if (result.shared_key && result.shared_key.length > 0) {
                displayFinalKey({...result, final_key: result.shared_key});
            }
        }

        // Enhanced security analysis display
        async function performAdvancedSecurityAnalysis(protocolResult) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/security/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        protocol_result: protocolResult,
                        advanced_analysis: true
                    })
                });

                if (response.ok) {
                    const securityAnalysis = await response.json();
                    if (securityAnalysis.success) {
                        displayAdvancedSecurityAnalysis(securityAnalysis);
                        if (lastSimulationResults) {
                            lastSimulationResults.enhanced_security_analysis = securityAnalysis;
                        }
                    }
                }
            } catch (error) {
                console.error('Security analysis failed:', error);
            }
        }

        function displayAdvancedSecurityAnalysis(analysis) {
            document.getElementById('advanced-analysis').style.display = 'block';

            // Finite-key analysis
            if (analysis.security_bounds) {
                document.getElementById('finite-key-analysis').innerHTML = `
                    <div class="highlight-box">
                        <h5>üìñ Understanding These Metrics</h5>
                        <p><strong>Effective QBER:</strong> Includes statistical corrections for finite-key effects</p>
                        <p><strong>Secure Key Bound:</strong> Maximum bits that can be securely extracted</p>
                        <p><strong>Statistical Fluctuation:</strong> Uncertainty due to finite sample size</p>
                    </div>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Effective QBER:</strong><br>
                            ${(analysis.security_bounds.effective_qber * 100).toFixed(3)}%
                        </div>
                        <div class="result-item">
                            <strong>Secure Key Bound:</strong><br>
                            ${analysis.security_bounds.secure_key_length} bits
                        </div>
                        <div class="result-item">
                            <strong>Finite-Key Regime:</strong><br>
                            ${analysis.security_bounds.finite_key_regime}
                        </div>
                        <div class="result-item">
                            <strong>Statistical Fluctuation:</strong><br>
                            ¬±${((analysis.security_bounds.statistical_fluctuation_term || 0) * 100).toFixed(2)}%
                        </div>
                    </div>
                `;
            }

            // QBER analysis
            if (analysis.qber_analysis) {
                const confidenceIntervals = analysis.qber_analysis.confidence_intervals || {};
                document.getElementById('qber-analysis').innerHTML = `
                    <div class="highlight-box">
                        <h5>üìä Statistical Confidence</h5>
                        <p>Confidence intervals show the range of possible true QBER values based on observed data.</p>
                    </div>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Measured QBER:</strong><br>
                            ${(analysis.qber_analysis.qber * 100).toFixed(3)}%
                        </div>
                        <div class="result-item">
                            <strong>95% Confidence Interval:</strong><br>
                            [${confidenceIntervals['95%'] ? (confidenceIntervals['95%'][0] * 100).toFixed(2) : 'N/A'}%, ${confidenceIntervals['95%'] ? (confidenceIntervals['95%'][1] * 100).toFixed(2) : 'N/A'}%]
                        </div>
                        <div class="result-item">
                            <strong>Security Level:</strong><br>
                            ${analysis.qber_analysis.current_security_level}
                        </div>
                        <div class="result-item">
                            <strong>Sample Reliability:</strong><br>
                            ${analysis.qber_analysis.reliable ? '‚úÖ Sufficient' : '‚ö†Ô∏è Limited'}
                        </div>
                    </div>
                `;
            }

            // Attack analysis
            if (analysis.attack_analysis && analysis.attack_analysis.attack_signatures) {
                document.getElementById('attack-analysis').innerHTML = `
                    <div class="highlight-box">
                        <h5>üéØ Attack Detection</h5>
                        <p>Different eavesdropping methods leave distinctive error signatures that can be identified.</p>
                    </div>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Threat Level:</strong><br>
                            ${analysis.attack_analysis.attack_signatures.threat_level}
                        </div>
                        <div class="result-item">
                            <strong>Assessment:</strong><br>
                            ${analysis.attack_analysis.attack_signatures.assessment || 'No assessment available'}
                        </div>
                        <div class="result-item">
                            <strong>Detection Confidence:</strong><br>
                            ${analysis.attack_analysis.attack_signatures.confidence || 'Unknown'}
                        </div>
                        <div class="result-item">
                            <strong>Most Likely Attack:</strong><br>
                            ${analysis.eavesdropping_analysis?.most_likely_attack || 'None identified'}
                        </div>
                    </div>
                `;
            }

            // Optimization recommendations
            if (analysis.optimization_recommendations) {
                const recommendations = analysis.optimization_recommendations.slice(0, 5);
                document.getElementById('optimization-recommendations').innerHTML = `
                    <div class="highlight-box">
                        <h5>üîß Performance Tips</h5>
                        <p>Based on your results, here are specific recommendations for improvement:</p>
                    </div>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                `;
            }
        }

        // Enhanced final key display with educational content
        function displayFinalKey(result) {
            const finalKeyDiv = document.getElementById('final-key');
            const keyContent = document.getElementById('key-content');
            const keyLength = document.getElementById('key-length');
            const keyEntropy = document.getElementById('key-entropy');
            const backendUsed = document.getElementById('backend-used');
            const keyMetadata = document.getElementById('key-metadata');
            const securityStatus = document.getElementById('security-status');

            const key = result.final_key || result.shared_key || [];

            if (key.length > 0) {
                // Enhanced key visualization with explanations
                let keyHTML = '<div class="highlight-box"><h4>üîç Understanding Your Key</h4><p>Each circle represents one bit of your quantum-generated key. Blue circles are 0s, red circles are 1s. The pattern should appear random‚Äîany visible patterns could indicate security issues.</p></div>';
                keyHTML += '<div class="bit-visualization">';
                key.slice(0, 50).forEach((bit, index) => {
                    keyHTML += `<span class="bit bit-${bit}" title="Bit ${index + 1}: ${bit} (Click to see details)" onclick="showBitDetails(${index}, ${bit})">${bit}</span>`;
                });
                if (key.length > 50) keyHTML += `<span style="color: #ccc; margin-left: 10px;">... +${key.length - 50} more bits</span>`;
                keyHTML += '</div>';
                keyHTML += `<div style="margin-top: 15px; font-family: monospace; word-break: break-all; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; font-size: 12px; max-height: 100px; overflow-y: auto;">${key.join('')}</div>`;

                keyContent.innerHTML = keyHTML;
                keyLength.textContent = `üî¢ Key Length: ${key.length} bits`;
                backendUsed.textContent = `‚öõÔ∏è Generated using: ${result.simulation_backend || result.backend_used || 'Python Backend'}`;

                // Enhanced entropy calculation with explanation
                const zeros = key.filter(bit => bit === 0).length;
                const ones = key.filter(bit => bit === 1).length;
                const p0 = zeros / key.length;
                const p1 = ones / key.length;
                const entropy = p0 > 0 && p1 > 0 ? -(p0 * Math.log2(p0) + p1 * Math.log2(p1)) : 0;
                keyEntropy.innerHTML = `üìä Entropy: ${entropy.toFixed(3)} bits/bit (max: 1.000) | Balance: ${zeros}√ó0, ${ones}√ó1`;

                // Enhanced metadata with educational info
                keyMetadata.innerHTML = `
                    <div class="highlight-box">
                        <h5>üéì Key Properties</h5>
                        <p><strong>üìÖ Generated:</strong> ${result.timestamp ? new Date(result.timestamp).toLocaleString() : 'Just now'}</p>
                        <p><strong>üîí Protocol:</strong> BB84 Quantum Key Distribution (Bennett-Brassard 1984)</p>
                        <p><strong>‚öñÔ∏è Security Type:</strong> Information-theoretic (physics-based, not math-based)</p>
                        <p><strong>üîë Usage:</strong> This key can be used for one-time pad encryption or as seed for symmetric cryptography</p>
                        <p><strong>‚ö†Ô∏è Important:</strong> In real QKD, this key would be immediately used and then securely deleted. Never reuse quantum keys!</p>
                    </div>
                `;

                finalKeyDiv.style.display = 'block';

                // Enhanced security status with detailed explanation
                const isSecure = result.security_analysis?.security_level === 'SECURE';
                securityStatus.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">
                            ${isSecure ? 'üîí CRYPTOGRAPHICALLY SECURE' : '‚ö†Ô∏è SECURITY COMPROMISED'}
                        </div>
                        <p style="margin: 0; font-size: 0.9em;">
                            ${isSecure ? 
                                'This key is protected by quantum mechanics and can be safely used for encryption.' : 
                                'High error rate detected. This key should not be used due to possible eavesdropping.'}
                        </p>
                    </div>
                `;
                securityStatus.className = `security-indicator ${isSecure ? 'secure' : 'insecure'}`;
            }
        }

        // Bit details function
        function showBitDetails(index, bit) {
            alert(`üîç Bit Details\n\nPosition: ${index + 1}\nValue: ${bit}\nType: ${bit === 0 ? 'Zero (possibly horizontal/+45¬∞ polarization)' : 'One (possibly vertical/-45¬∞ polarization)'}\n\nThis bit was generated through authentic quantum processes and verified through the BB84 protocol.`);
        }

        // Export functionality
        function exportResults(format) {
            if (!lastSimulationResults) {
                alert('üìã No simulation results to export.\n\nPlease run a BB84 simulation first to generate exportable data.');
                return;
            }

            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `bb84_quantum_simulation_${timestamp}`;

            switch (format) {
                case 'json':
                    exportAsJSON(lastSimulationResults, filename);
                    break;
                case 'csv':
                    exportAsCSV(lastSimulationResults, filename);
                    break;
                case 'pdf':
                    generateTextReport(lastSimulationResults, filename);
                    break;
            }
        }

        function exportAsJSON(data, filename) {
            const exportData = {
                export_metadata: {
                    export_time: new Date().toISOString(),
                    export_format: 'JSON',
                    software: 'QuantumCrypto Educational Tutorial',
                    bb84_version: '2024_enhanced'
                },
                educational_summary: {
                    protocol: 'BB84 Quantum Key Distribution',
                    security_basis: 'Information-theoretic (quantum mechanics)',
                    key_features: ['Eavesdropping detection', 'Quantum uncertainty principle', 'No-cloning theorem']
                },
                simulation_results: data
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            downloadBlob(blob, filename + '.json');
        }

        function exportAsCSV(data, filename) {
            let csv = 'Parameter,Value,Educational_Note\n';
            csv += `Simulation Backend,${data.simulation_backend || 'Unknown'},"Quantum computing framework used"\n`;
            csv += `Total Qubits,${data.total_bits || 'N/A'},"Photons transmitted from Alice to Bob"\n`;
            csv += `Sifted Key Length,${data.sifted_bits || 'N/A'},"Bits remaining after basis reconciliation"\n`;
            csv += `Final Key Length,${data.final_key_length || 'N/A'},"Bits after error correction and privacy amplification"\n`;
            csv += `QBER,${((data.error_rate || 0) * 100).toFixed(3)}%,"Quantum Bit Error Rate (security threshold: 11%)"\n`;
            csv += `Protocol Efficiency,${((data.protocol_efficiency || 0) * 100).toFixed(1)}%,"Final key bits / Initial bits"\n`;
            csv += `Eavesdropper Present,${data.eavesdropper_present || false},"Whether Eve was simulated"\n`;
            csv += `Security Level,${data.security_analysis?.security_level || 'Unknown'},"Information-theoretic security assessment"\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            downloadBlob(blob, filename + '.csv');
        }

        function generateTextReport(data, filename) {
            let report = `BB84 Quantum Key Distribution - Educational Simulation Report\n`;
            report += `==========================================================\n\n`;
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Software: QuantumCrypto Educational Tutorial\n\n`;

            report += `SIMULATION PARAMETERS:\n`;
            report += `----------------------\n`;
            report += `Quantum Backend: ${data.simulation_backend || 'Unknown'}\n`;
            report += `Total Qubits: ${data.total_bits || 'N/A'}\n`;
            report += `Eavesdropper Simulated: ${data.eavesdropper_present ? 'Yes (Eve present)' : 'No (Secure channel)'}\n`;
            report += `Channel Noise: ${((data.noise_level || 0) * 100).toFixed(1)}%\n\n`;

            report += `RESULTS:\n`;
            report += `--------\n`;
            report += `Sifted Key Length: ${data.sifted_bits || 'N/A'} bits\n`;
            report += `Final Key Length: ${data.final_key_length || 'N/A'} bits\n`;
            report += `QBER: ${((data.error_rate || 0) * 100).toFixed(3)}% (Threshold: 11%)\n`;
            report += `Protocol Efficiency: ${((data.protocol_efficiency || 0) * 100).toFixed(1)}%\n`;
            report += `Security Status: ${data.security_analysis?.security_level || 'Unknown'}\n\n`;

            report += `EDUCATIONAL INSIGHTS:\n`;
            report += `--------------------\n`;
            report += `‚Ä¢ BB84 provides information-theoretic security based on quantum mechanics\n`;
            report += `‚Ä¢ QBER above 11% indicates possible eavesdropping or excessive noise\n`;
            report += `‚Ä¢ Quantum no-cloning theorem prevents perfect copying of quantum states\n`;
            report += `‚Ä¢ Real QKD systems require error correction and privacy amplification\n\n`;

            report += `Generated by QuantumCrypto Tutorial - Learn quantum cryptography through practice!\n`;

            const blob = new Blob([report], { type: 'text/plain' });
            downloadBlob(blob, filename + '_educational_report.txt');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Enhanced tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Enhanced parameter updates with educational feedback
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize backend connection
            initializeBackend();

            // Enhanced noise level display
            const noiseLevel = document.getElementById('noiseLevel');
            const noiseValue = document.getElementById('noiseValue');
            if (noiseLevel && noiseValue) {
                noiseValue.textContent = (parseFloat(noiseLevel.value) * 100).toFixed(1) + '%';

                noiseLevel.addEventListener('input', function() {
                    const percentage = (parseFloat(this.value) * 100).toFixed(1);
                    noiseValue.textContent = percentage + '%';
                });
            }

            // Enhanced periodic backend check
            setInterval(initializeBackend, 30000); // Check every 30 seconds

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    runPythonBB84Simulation();
                }
            });
        });
    </script>
</body>
</html>
